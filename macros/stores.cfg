#in game shops/stores

#define RED_COST PATH
	{CLEAR_VARIABLE red_cost}
	{CLEAR_VARIABLE red_cost2}
	[if]
		[variable]
			name={PATH}
			greater_than=$current_unit.variables.personal_gold
		[/variable]
		[then]
			{VARIABLE red_cost "<span foreground='red'>"}
			{VARIABLE red_cost2 "</span>"}
		[/then]
	[/if]
#enddef

#define CREATE_WEAPON_INSERT_TO_SHOP
	{RANDOM 0..3}
	[if]
		[variable]
			name=random
			numerical_equals=0
		[/variable]
		[then]
			{VARIABLE_OP new_weapon_rank rand 0..$dungeon_level.max}
		[/then]
		[else]
			{VARIABLE level_minus_3 $dungeon_level.max}
			{VARIABLE_OP level_minus_3 sub 3}
			[if]
				[variable]
					name=level_minus_3
					less_than=0
				[/variable]
				[then]
					{VARIABLE level_minus_3 0}
				[/then]
			[/if]
			{VARIABLE_OP new_weapon_rank rand $level_minus_3..$dungeon_level.max}
		[/else]
	[/if]
	{RANDOM 0..2}
	{VARIABLE_OP new_weapon_rank add $random}
	{RANDOM_WEAPON prob_overworld_shop_weapon $new_weapon_rank random new_weapon}

	[if]
		[variable]
			name=new_weapon.category
			equals=melee_weapon
		[/variable]
		[then]
			[set_variables]
				name=weapon_shop.weapons.melee
				mode=append
				[insert_tag]
					name=value
					variable=new_weapon
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
	[if]
		[variable]
			name=new_weapon.category
			equals=ranged_weapon
		[/variable]
		[then]
			[set_variables]
				name=weapon_shop.weapons.ranged
				mode=append
				[insert_tag]
					name=value
					variable=new_weapon
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
#enddef

#define CREATE_ARMOR_INSERT_TO_SHOP
	{RANDOM 0..3}
	[if]
		[variable]
			name=random
			numerical_equals=0
		[/variable]
		[then]
			{VARIABLE_OP new_armor_rank rand 0..$dungeon_level.max}
		[/then]
		[else]
			{VARIABLE level_minus_3 $dungeon_level.max}
			{VARIABLE_OP level_minus_3 add  -3}
			[if]
				[variable]
					name=level_minus_3
					less_than=0
				[/variable]
				[then]
					{VARIABLE level_minus_3 0}
				[/then]
			[/if]
			{VARIABLE_OP new_armor_rank rand $level_minus_3..$dungeon_level.max}
		[/else]
	[/if]
	{RANDOM 0..2}
	{VARIABLE_OP new_armor_rank add $random}
	{RANDOM_ARMOR prob_overworld_shop_armor $new_armor_rank random new_armor}

	[if]
		[variable]
			name=new_armor.category
			equals=torso_armor
		[/variable]
		[then]
			[set_variables]
				name=armor_shop.armor.torso
				mode=append
				[insert_tag]
					name=value
					variable=new_armor
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
	[if]
		[variable]
			name=new_armor.category
			equals=legs_armor
		[/variable]
		[then]
			[set_variables]
				name=armor_shop.armor.legs
				mode=append
				[insert_tag]
					name=value
					variable=new_armor
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
	[if]
		[variable]
			name=new_armor.category
			equals=head_armor
		[/variable]
		[then]
			[set_variables]
				name=armor_shop.armor.head
				mode=append
				[insert_tag]
					name=value
					variable=new_armor
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
	[if]
		[variable]
			name=new_armor.category
			equals=shield
		[/variable]
		[then]
			[set_variables]
				name=armor_shop.armor.shield
				mode=append
				[insert_tag]
					name=value
					variable=new_armor
				[/insert_tag]
			[/set_variables]
		[/then]
	[/if]
#enddef

# MODRPG_SHOP_ON_SALE - Generate a prob-list bump event for item sales
# SHOP      One of weapon, armor, magic
#
# Inputs:
# shop.item path to the item sold
# shop.unit path to the buyer
#
# FIXME: This should increase linearly instead of exponentially, i.e., increase by 10% of
# *original* value, and not the *current* one. The prob_list code will need to be modified
# in order for this to happen, as they wouldn't currently support such operations. Otherwise,
# uncomonly purchased items would virtually disappear from the shop.
#
# The prob_lists should probably be made const and use a modifier object instead.
#define MODRPG_SHOP_ON_SALE SHOP
[event]
	name=on_{SHOP}_shop_sale
	first_time_only=no

	[set_prob]
		name=prob_overworld_shop_{SHOP}
		op=scale
		item=$shop.item|.prob_name
		weight=110
	[/set_prob]
	# [dump]
	#     [value]
	#         msg="I did it for $shop.item|, promise!"
	#     [/value]
	# [/dump]
[/event]
#enddef

# MODRPG_SHOP_GEN_MENU - Generate menu for shoppers
# SRC       source array
# DST       destination array
# UNIT      path to the unit
# INV_PATH  path to item storage relative to {UNIT}.variables.inventory
# ON_SALE   event to fire upon sale. Will have shop.unit and shop.item populated
#
# Uses $i
# TODO: Modify so that henchment can use
#define MODRPG_SHOP_GEN_MENU SRC DST UNIT INV_PATH ON_SALE
	[for]
		array={SRC}
		variable=i
		[do]
		{RED_COST "{SRC}[$i].absolute_value"}
		[describe_item]
			item={SRC}[$i]
			dest={DST}
			unit={UNIT}
			mode=append
			description=_"$red_cost|${SRC}[$i].absolute_value|$red_cost2|"
			[command]
				[if]
					[variable]
						name={UNIT}.variables.personal_gold
						less_than=${SRC}[$i].absolute_value
					[/variable]
					[then]
						[message]
							speaker=narrator
							message=_ "You do not have enough gold to purchase that!"
							image=wesnoth-icon.png
						[/message]
					[/then]
					[else]
						{VARIABLE shop.item {SRC}[$i]}
						{VARIABLE shop.unit {UNIT}}
						[fire_event]
							name={ON_SALE}
						[/fire_event]
						[set_prob]
							name=prob_overworld_shop_weapon
							op=scale
							item=${SRC}[$i].prob_name
							weight=110
						[/set_prob]
						{VARIABLE_OP {UNIT}.variables.personal_gold sub ${SRC}[$i].absolute_value}
						[set_variables]
							name={UNIT}.variables.inventory.{INV_PATH}
							mode=append
							[insert_tag]
								name=literal
								variable={SRC}[$i]
							[/insert_tag]
						[/set_variables]
						{CLEAR_VARIABLE "{SRC}[$i]"}
					[/else]
				[/if]
			[/command]
		[/describe_item]
		[/do]
	[/for]
	[if]
		[variable]
			name={DST}.length
			less_than=1
		[/variable]
		[then]
			[set_variables]
				name={DST}
				mode=append
				[value]
					label=_ " "
					description=_ " "
					image=misc/blank-hex.png
					[command]
					[/command]
				[/value]
			[/set_variables]
		[/then]
	[/if]
#enddef

#define WESBAND_WEAPON_SHOP
	[set_menu_item]
		id=a_wesband_weapon_shop
		image=commands/button_village.png
		description=_ "Enter shop"
		[filter_location]
			x,y=$weapon_shop_loc_x,$weapon_shop_loc_y
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
		[/filter_location]
		[command]
			[store_unit]
				variable=current_unit
				[filter]
					side=$side_number
					canrecruit=yes
					x,y=$x1,$y1
				[/filter]
			[/store_unit]
			{VARIABLE unit_path current_unit}
			{VARIABLE in_shop 1}
			[while]
				[variable]
					name=in_shop
					greater_than=0
				[/variable]
				[do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
					{CLEAR_VARIABLE shop_item_insert_melee}
					{CLEAR_VARIABLE shop_item_insert_ranged}
					{MODRPG_LIST_EQUIPPED_WEAPONS
						shop_item_insert_melee
						current_unit
						1
						_"<small><small>equipped</small></small>"
						()}
					[dump]
						var=shop_item_insert_melee
					[/dump]
					{MODRPG_SHOP_GEN_MENU
						weapon_shop.weapons.melee
						shop_item_insert_melee
						current_unit
						weapons.melee
						on_weapon_shop_sale}

					{MODRPG_SHOP_GEN_MENU
						weapon_shop.weapons.ranged
						shop_item_insert_ranged
						current_unit
						weapons.ranged
						on_weapon_shop_sale}

					#{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
					[message]
						image=$shop_names.weapon3
						speaker=narrator
						message= _ "Welcome to $shop_names.weapon|'s $shop_names.weapon2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
						[option]
							label=_ "End purchase."
							image=check.png
							[command]
								[unstore_unit]
									variable=current_unit
								[/unstore_unit]
								[modify_side]
									side=$current_unit.side
									gold=$current_unit.variables.personal_gold
								[/modify_side]
								{VARIABLE in_shop 0}
							[/command]
						[/option]
						[option]
							label=_ "Sell to store."
							image=check.png
							[command]
								{VARIABLE in_shop 2}
								[while]
									[variable]
										name=in_shop
										greater_than=1
									[/variable]
									[do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
										{CLEAR_VARIABLE sell_item_insert}
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.weapons.melee
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.melee_1
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.equipment_slots.melee_2
															numerical_equals=$i
														[/variable]
														[or]
															[variable]
																name=current_unit.variables.equipment_slots.melee_3
																numerical_equals=$i
															[/variable]
															[or]
																[variable]
																	name=current_unit.variables.inventory.weapons.melee[$i].undroppable
																	numerical_equals=1
																[/variable]
															[/or]
														[/or]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.weapons.melee[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														# [calculate_weapon_display]
														#     unit_variable=current_unit
														#     weapon_variable=current_unit.variables.inventory.weapons.melee[$i]
														# [/calculate_weapon_display]
														[describe_item]
															item=current_unit.variables.inventory.weapons.melee[$i]
															unit=current_unit
															dest=sorted_sell
															mode=append
															description=_"$temp_value"
															[command]
																{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																[set_variables]
																	name=weapon_shop.weapons.melee
																	mode=append
																	[insert_tag]
																		name=literal
																		variable=current_unit.variables.inventory.weapons.melee[$i]
																	[/insert_tag]
																[/set_variables]
																[clear_variable]
																	name=current_unit.variables.inventory.weapons.melee[$i]
																[/clear_variable]
																[if]
																	[variable]
																		name=current_unit.variables.equipment_slots.melee_1
																		greater_than=$i
																	[/variable]
																	[then]
																		{VARIABLE_OP current_unit.variables.equipment_slots.melee_1 sub 1}
																	[/then]
																[/if]
																[if]
																	[variable]
																		name=current_unit.variables.equipment_slots.melee_2
																		greater_than=$i
																	[/variable]
																	[then]
																		{VARIABLE_OP current_unit.variables.equipment_slots.melee_2 sub 1}
																	[/then]
																[/if]
																[if]
																	[variable]
																		name=current_unit.variables.equipment_slots.melee_3
																		greater_than=$i
																	[/variable]
																	[then]
																		{VARIABLE_OP current_unit.variables.equipment_slots.melee_3 sub 1}
																	[/then]
																[/if]
															[/command]
														[/describe_item]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.weapons.ranged
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.ranged
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.weapons.ranged[$i].undroppable
															numerical_equals=1
														[/variable]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.weapons.ranged[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														# [calculate_weapon_display]
														#     unit_variable=current_unit
														#     weapon_variable=current_unit.variables.inventory.weapons.ranged[$i]
														# [/calculate_weapon_display]
														[describe_item]
															item=current_unit.variables.inventory.weapons.ranged[$i]
															unit=current_unit
															dest=sorted_sell
															mode=append
															description=_"$temp_value"
															[command]
																{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																[set_variables]
																	name=weapon_shop.weapons.ranged
																	mode=append
																	[insert_tag]
																		name=literal
																		variable=current_unit.variables.inventory.weapons.ranged[$i]
																	[/insert_tag]
																[/set_variables]
																[clear_variable]
																	name=current_unit.variables.inventory.weapons.ranged[$i]
																[/clear_variable]
																[if]
																	[variable]
																		name=current_unit.variables.equipment_slots.ranged
																		greater_than=$i
																	[/variable]
																	[then]
																		{VARIABLE_OP current_unit.variables.equipment_slots.ranged sub 1}
																	[/then]
																[/if]
															[/command]
														[/describe_item]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[if]
											[variable]
												name=sell_item_insert.length
												less_than=1
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You have no items to sell."
													image=wesnoth-icon.png
													side_for=$current_unit.side
												[/message]
												{VARIABLE in_shop 1}
											[/then]
											[else]
												[message]
													speaker=narrator
													message= _ "Sell which item?"
													[option]
														label=_ "End selling."
														image=check.png
														[command]
															[modify_side]
																side=$current_unit.side
																gold=$current_unit.variables.personal_gold
															[/modify_side]
															{VARIABLE in_shop 1}
														[/command]
													[/option]
													[insert_tag]
														name=option
														variable=sell_item_insert
													[/insert_tag]
													image=wesnoth-icon.png
												[/message]
											[/else]
										[/if]
									[/do]
								[/while]
							[/command]
						[/option]
						{SHOP_DIVIDER_MELEE_WEAPONS}
						[insert_tag]
							name=option
							variable=shop_item_insert_melee
						[/insert_tag]
						{SHOP_DIVIDER_RANGED_WEAPONS}
						[insert_tag]
							name=option
							variable=shop_item_insert_ranged
						[/insert_tag]
					[/message]
				[/do]
			[/while]
			{CLEAR_VARIABLE sell_item_insert}
		[/command]
	[/set_menu_item]
	[event]
		name=scenario_end
		[clear_menu_item]
			id=a_wesband_weapon_shop
		[/clear_menu_item]
	[/event]
#enddef

#define WESBAND_ARMOR_SHOP
	[set_menu_item]
		id=a_wesband_armor_shop
		image=commands/button_village.png
		description=_ "Enter shop"
		[filter_location]
			x,y=$armor_shop_loc_x,$armor_shop_loc_y
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
		[/filter_location]
		[command]
			[store_unit]
				variable=current_unit
				[filter]
					side=$side_number
					canrecruit=yes
					x,y=$x1,$y1
				[/filter]
			[/store_unit]
			{VARIABLE in_shop 1}
			[while]
				[variable]
					name=in_shop
					greater_than=0
				[/variable]
				[do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
					{CLEAR_VARIABLE shop_item_insert_torso}
					{CLEAR_VARIABLE shop_item_insert_legs}
					{CLEAR_VARIABLE shop_item_insert_head}
					{CLEAR_VARIABLE shop_item_insert_shield}

					{MODRPG_SHOP_GEN_MENU
						armor_shop.armor.torso
						shop_item_insert_torso
						current_unit
						armor.torso
						on_armor_shop_sale}

					{MODRPG_SHOP_GEN_MENU
						armor_shop.armor.legs
						shop_item_insert_legs
						current_unit
						armor.legs
						on_armor_shop_sale}

					{MODRPG_SHOP_GEN_MENU
						armor_shop.armor.head
						shop_item_insert_head
						current_unit
						armor.head
						on_armor_shop_sale}

					{MODRPG_SHOP_GEN_MENU
						armor_shop.armor.shield
						shop_item_insert_shield
						current_unit
						armor.shield
						on_armor_shop_sale}

					#{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
					[message]
						image=$shop_names.armor3
						speaker=narrator
						message= _ "Welcome to $shop_names.armor|'s $shop_names.armor2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
						[option]
							label=_ "End purchase."
							image=check.png
							[command]
								[unstore_unit]
									variable=current_unit
								[/unstore_unit]
								[modify_side]
									side=$current_unit.side
									gold=$current_unit.variables.personal_gold
								[/modify_side]
								{VARIABLE in_shop 0}
							[/command]
						[/option]
						[option]
							label=_ "Sell to store."
							image=check.png
							[command]
								{VARIABLE in_shop 2}
								[while]
									[variable]
										name=in_shop
										greater_than=1
									[/variable]
									[do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
										{CLEAR_VARIABLE sell_item_insert}
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.armor.torso
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.torso_armor
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.armor.torso[$i].undroppable
															numerical_equals=1
														[/variable]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.armor.torso[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														[set_variables]
															name=sorted_sell
															mode=append
															[value]
																{DISPLAY_TORSO_ARMOR (current_unit.variables.inventory.armor.torso[$i])}
																description=_"$temp_value"
																[command]
																	{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																	[set_variables]
																		name=armor_shop.armor.torso
																		mode=append
																		[insert_tag]
																			name=literal
																			variable=current_unit.variables.inventory.armor.torso[$i]
																		[/insert_tag]
																	[/set_variables]
																	[clear_variable]
																		name=current_unit.variables.inventory.armor.torso[$i]
																	[/clear_variable]
																	[if]
																		[variable]
																			name=current_unit.variables.equipment_slots.torso_armor
																			greater_than=$i
																		[/variable]
																		[then]
																			{VARIABLE_OP current_unit.variables.equipment_slots.torso_armor sub 1}
																		[/then]
																	[/if]
																[/command]
															[/value]
														[/set_variables]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.armor.head
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.head_armor
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.armor.head[$i].undroppable
															numerical_equals=1
														[/variable]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.armor.head[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														[set_variables]
															name=sorted_sell
															mode=append
															[value]
																{DISPLAY_HEAD_ARMOR (current_unit.variables.inventory.armor.head[$i])}
																description=_"$temp_value"
																[command]
																	{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																	[set_variables]
																		name=armor_shop.armor.head
																		mode=append
																		[insert_tag]
																			name=literal
																			variable=current_unit.variables.inventory.armor.head[$i]
																		[/insert_tag]
																	[/set_variables]
																	[clear_variable]
																		name=current_unit.variables.inventory.armor.head[$i]
																	[/clear_variable]
																	[if]
																		[variable]
																			name=current_unit.variables.equipment_slots.head_armor
																			greater_than=$i
																		[/variable]
																		[then]
																			{VARIABLE_OP current_unit.variables.equipment_slots.head_armor sub 1}
																		[/then]
																	[/if]
																[/command]
															[/value]
														[/set_variables]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.armor.shield
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.shield
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.armor.shield[$i].undroppable
															numerical_equals=1
														[/variable]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.armor.shield[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														[set_variables]
															name=sorted_sell
															mode=append
															[value]
																{DISPLAY_SHIELD (current_unit.variables.inventory.armor.shield[$i])}
																description=_"$temp_value"
																[command]
																	{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																	[set_variables]
																		name=armor_shop.armor.shield
																		mode=append
																		[insert_tag]
																			name=literal
																			variable=current_unit.variables.inventory.armor.shield[$i]
																		[/insert_tag]
																	[/set_variables]
																	[clear_variable]
																		name=current_unit.variables.inventory.armor.shield[$i]
																	[/clear_variable]
																	[if]
																		[variable]
																			name=current_unit.variables.equipment_slots.shield
																			greater_than=$i
																		[/variable]
																		[then]
																			{VARIABLE_OP current_unit.variables.equipment_slots.shield sub 1}
																		[/then]
																	[/if]
																[/command]
															[/value]
														[/set_variables]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.armor.legs
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.equipment_slots.leg_armor
														numerical_equals=$i
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.armor.legs[$i].undroppable
															numerical_equals=1
														[/variable]
													[/or]
													[then]
													[/then]
													[else]
														{VARIABLE temp_value $current_unit.variables.inventory.armor.legs[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .2}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														[set_variables]
															name=sorted_sell
															mode=append
															[value]
																{DISPLAY_LEGS_ARMOR (current_unit.variables.inventory.armor.legs[$i])}
																description=_"$temp_value"
																[command]
																	{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																	[set_variables]
																		name=armor_shop.armor.legs
																		mode=append
																		[insert_tag]
																			name=literal
																			variable=current_unit.variables.inventory.armor.legs[$i]
																		[/insert_tag]
																	[/set_variables]
																	[clear_variable]
																		name=current_unit.variables.inventory.armor.legs[$i]
																	[/clear_variable]
																	[if]
																		[variable]
																			name=current_unit.variables.equipment_slots.leg_armor
																			greater_than=$i
																		[/variable]
																		[then]
																			{VARIABLE_OP current_unit.variables.equipment_slots.leg_armor sub 1}
																		[/then]
																	[/if]
																[/command]
															[/value]
														[/set_variables]
													[/else]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[if]
											[variable]
												name=sell_item_insert.length
												less_than=1
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You have no items to sell."
													image=wesnoth-icon.png
													side_for=$current_unit.side
												[/message]
												{VARIABLE in_shop 1}
											[/then]
											[else]
												[message]
													speaker=narrator
													message= _ "Sell which item?"
													[option]
														label=_ "End selling."
														image=check.png
														[command]
															[modify_side]
																side=$current_unit.side
																gold=$current_unit.variables.personal_gold
															[/modify_side]
															{VARIABLE in_shop 1}
														[/command]
													[/option]
													[insert_tag]
														name=option
														variable=sell_item_insert
													[/insert_tag]
													image=wesnoth-icon.png
												[/message]
											[/else]
										[/if]
									[/do]
								[/while]
							[/command]
						[/option]
						{SHOP_DIVIDER_TORSO_ARMOR}
						[insert_tag]
							name=option
							variable=shop_item_insert_torso
						[/insert_tag]
						{SHOP_DIVIDER_LEG_ARMOR}
						[insert_tag]
							name=option
							variable=shop_item_insert_legs
						[/insert_tag]
						{SHOP_DIVIDER_HEAD_ARMOR}
						[insert_tag]
							name=option
							variable=shop_item_insert_head
						[/insert_tag]
						{SHOP_DIVIDER_SHIELDS}
						[insert_tag]
							name=option
							variable=shop_item_insert_shield
						[/insert_tag]
					[/message]
				[/do]
			[/while]
			{CLEAR_VARIABLE sell_item_insert}
		[/command]
	[/set_menu_item]
	[event]
		name=scenario_end
		[clear_menu_item]
			id=a_wesband_armor_shop
		[/clear_menu_item]
	[/event]
#enddef

#define WESBAND_MAGIC_SHOP
	[set_menu_item]
		id=a_wesband_magic_shop
		image=commands/button_village.png
		description=_ "Enter shop"
		[filter_location]
			x,y=$magic_shop_loc_x,$magic_shop_loc_y
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
		[/filter_location]
		[command]
			[store_unit]
				variable=current_unit
				[filter]
					side=$side_number
					canrecruit=yes
					x,y=$x1,$y1
				[/filter]
			[/store_unit]
			{VARIABLE unit_path current_unit}
			{VARIABLE in_shop 1}
			[while]
				[variable]
					name=in_shop
					greater_than=0
				[/variable]
				[do]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
					{CLEAR_VARIABLE shop_item_insert_potions}
					[for]
						array=magic_shop.potions
						variable=i
						[do]
							{RED_COST "magic_shop.potions[$i].absolute_value"}
							[set_variables]
								name=shop_item_insert_potions
								mode=append
								[value]
									label=_ "$magic_shop.potions[$i].description|"
									description=_"$red_cost|$magic_shop.potions[$i].absolute_value|$red_cost2|"
									image=$magic_shop.potions[$i].icon|.png
									[command]
										[if]
											[variable]
												name=current_unit.variables.personal_gold
												less_than=$magic_shop.potions[$i].absolute_value
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You do not have enough gold to purchase that!"
													image=wesnoth-icon.png
												[/message]
											[/then]
											[else]
												[set_prob]
													name=prob_overworld_shop_potion
													op=scale
													item=$magic_shop.potions[$i].prob_name
													weight=110
												[/set_prob]
												{VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.potions[$i].absolute_value}
												[set_variables]
													name=current_unit.variables.inventory.usables
													mode=append
													[insert_tag]
														name=literal
														variable=magic_shop.potions[$i]
													[/insert_tag]
												[/set_variables]
												{CLEAR_VARIABLE "magic_shop.potions[$i]"}
											[/else]
										[/if]
									[/command]
								[/value]
							[/set_variables]
						[/do]
					[/for]
					[if]
						[variable]
							name=shop_item_insert_potions.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_potions
								mode=append
								[value]
									label=_ " "
									description=_ " "
									image=misc/blank-hex.png
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

					{CLEAR_VARIABLE shop_item_insert_scrolls}
					[for]
						array=magic_shop.scrolls
						variable=i
						[do]
							{RED_COST "magic_shop.scrolls[$i].absolute_value"}
							[set_variables]
								name=shop_item_insert_scrolls
								mode=append
								[value]
									label=_ "$magic_shop.scrolls[$i].description|"
									description=_"$red_cost|$magic_shop.scrolls[$i].absolute_value|$red_cost2|"
									image=$magic_shop.scrolls[$i].icon|.png
									[command]
										[if]
											[variable]
												name=current_unit.variables.personal_gold
												less_than=$magic_shop.scrolls[$i].absolute_value
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You do not have enough gold to purchase that!"
													image=wesnoth-icon.png
												[/message]
											[/then]
											[else]
												[set_prob]
													name=prob_overworld_shop_scroll
													op=scale
													item=$magic_shop.scrolls[$i].prob_name
													weight=110
												[/set_prob]
												{VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.scrolls[$i].absolute_value}
												[set_variables]
													name=current_unit.variables.inventory.usables
													mode=append
													[insert_tag]
														name=literal
														variable=magic_shop.scrolls[$i]
													[/insert_tag]
												[/set_variables]
												{CLEAR_VARIABLE "magic_shop.scrolls[$i]"}
											[/else]
										[/if]
									[/command]
								[/value]
							[/set_variables]
						[/do]
					[/for]
					[if]
						[variable]
							name=shop_item_insert_scrolls.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_scrolls
								mode=append
								[value]
									label=_ " "
									description=_ " "
									image=misc/blank-hex.png
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

					{CLEAR_VARIABLE shop_item_insert_tomes}
					[for]
						array=magic_shop.tomes
						variable=i
						[do]
							[set_variables]
								name=shop_item_insert_tomes
								mode=append
								[value]
									label=_ "$magic_shop.tomes[$i].description|"
									description=_"$magic_shop.tomes[$i].absolute_value"
									image=$magic_shop.tomes[$i].icon|.png
									[command]
										[if]
											[variable]
												name=current_unit.variables.personal_gold
												less_than=$magic_shop.tomes[$i].absolute_value
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You do not have enough gold to purchase that!"
													image=wesnoth-icon.png
												[/message]
											[/then]
											[else]
												{VARIABLE_OP current_unit.variables.personal_gold sub $magic_shop.tomes[$i].absolute_value}
												[set_variables]
													name=current_unit.variables.inventory.usables
													mode=append
													[insert_tag]
														name=literal
														variable=magic_shop.tomes[$i]
													[/insert_tag]
												[/set_variables]
												{CLEAR_VARIABLE "magic_shop.tomes[$i]"}
											[/else]
										[/if]
									[/command]
								[/value]
							[/set_variables]
						[/do]
					[/for]
					[if]
						[variable]
							name=shop_item_insert_tomes.length
							less_than=1
						[/variable]
						[then]
							[set_variables]
								name=shop_item_insert_tomes
								mode=append
								[value]
									label=_ " "
									description=_ " "
									image=misc/blank-hex.png
									[command]
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]

					#{VARIABLE creation_gold $current_unit.variables.personal_gold} want to be side gold to personal_golde
					[message]
						image=$shop_names.magic3
						speaker=narrator
						message= _ "Welcome to $shop_names.magic|'s $shop_names.magic2|. Be sure to check back later, as I frequently get new stock.

<small>You have $current_unit.variables.personal_gold| gold to spend. Which item will you buy?</small>"
						[option]
							label=_ "End purchase."
							image=check.png
							[command]
								[unstore_unit]
									variable=current_unit
								[/unstore_unit]
								[construct_unit]
									variable=$unit_path
								[/construct_unit]
								[modify_side]
									side=$current_unit.side
									gold=$current_unit.variables.personal_gold
								[/modify_side]
								{VARIABLE in_shop 0}
							[/command]
						[/option]
						[option]
							label=_ "Sell to store."
							image=check.png
							[command]
								{VARIABLE in_shop 2}
								[while]
									[variable]
										name=in_shop
										greater_than=1
									[/variable]
									[do]
										[modify_side]
											side=$current_unit.side
											gold=$current_unit.variables.personal_gold
										[/modify_side]
										{CLEAR_VARIABLE sell_item_insert}
										{CLEAR_VARIABLE sorted_sell}
										[for]
											array=current_unit.variables.inventory.usables
											variable=i
											[do]
												[if]
													[variable]
														name=current_unit.variables.inventory.usables[$i].user_name
														numerical_equals=potion
													[/variable]
													[or]
														[variable]
															name=current_unit.variables.inventory.usables[$i].user_name
															numerical_equals=scroll
														[/variable]
													[/or]
													[then]
														{VARIABLE temp_value $current_unit.variables.inventory.usables[$i].absolute_value}
														{VARIABLE_OP temp_value multiply .3}
														{VARIABLE_OP temp_value round "floor"}
														{IF_VAR temp_value less_than 1 (
															[then]
																{VARIABLE temp_value 1}
															[/then]
														)}
														[set_variables]
															name=sorted_sell
															mode=append
															[value]
																label=_ "$current_unit.variables.inventory.usables[$i].description|"
																description=_"$temp_value"
																image=$current_unit.variables.inventory.usables[$i].icon|.png
																[command]
																	{VARIABLE_OP current_unit.variables.personal_gold add $temp_value}
																	[set_variables]
																		name=magic_shop.$current_unit.variables.inventory.usables[$i].user_name|s
																		mode=append
																		[insert_tag]
																			name=literal
																			variable=current_unit.variables.inventory.usables[$i]
																		[/insert_tag]
																	[/set_variables]
																	[clear_variable]
																		name=current_unit.variables.inventory.usables[$i]
																	[/clear_variable]
																[/command]
															[/value]
														[/set_variables]
													[/then]
												[/if]
											[/do]
										[/for]
										[wbd_sort_array]
											name=sorted_sell
											first_key=label
											second_key=description
										[/wbd_sort_array]
										[set_variables]
											name=sell_item_insert
											mode=append
											to_variable=sorted_sell
										[/set_variables]
										{CLEAR_VARIABLE sorted_sell}
										[if]
											[variable]
												name=sell_item_insert.length
												less_than=1
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You have no items to sell."
													image=wesnoth-icon.png
													side_for=$current_unit.side
												[/message]
												{VARIABLE in_shop 1}
											[/then]
											[else]
												[message]
													speaker=narrator
													message= _ "Sell which item?"
													[option]
														label=_ "End selling."
														image=check.png
														[command]
															[modify_side]
																side=$current_unit.side
																gold=$current_unit.variables.personal_gold
															[/modify_side]
															{VARIABLE in_shop 1}
														[/command]
													[/option]
													[insert_tag]
														name=option
														variable=sell_item_insert
													[/insert_tag]
													image=wesnoth-icon.png
												[/message]
											[/else]
										[/if]
									[/do]
								[/while]
							[/command]
						[/option]
						{SHOP_DIVIDER_POTIONS}
						[insert_tag]
							name=option
							variable=shop_item_insert_potions
						[/insert_tag]
						{SHOP_DIVIDER_SCROLLS}
						[insert_tag]
							name=option
							variable=shop_item_insert_scrolls
						[/insert_tag]
#ifdef ENABLE_TOMES
						{SHOP_DIVIDER_TOMES}
						[insert_tag]
						   name=option
						   variable=shop_item_insert_tomes
						[/insert_tag]
#endif
					[/message]
				[/do]
			[/while]
			{CLEAR_VARIABLE sell_item_insert}
		[/command]
	[/set_menu_item]
	[event]
		name=scenario_end
		[clear_menu_item]
			id=a_wesband_magic_shop
		[/clear_menu_item]
	[/event]
#enddef

#define WESBAND_TAVERN
	[set_menu_item]
		id=a_wesband_tavern
		image=commands/button_village.png
		description=_ "Enter tavern"
		[filter_location]
			x,y=$tavern_loc_x,$tavern_loc_y
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
		[/filter_location]
		[command]
			[store_unit]
				[filter]
					side=$const.player_sides
					canrecruit=yes
				[/filter]
				variable=hench_num_query
			[/store_unit]
			[switch]
				variable=hench_num_query.length
				[case]
					value=1
					{VARIABLE max_hench 5}
				[/case]
				[case]
					value=2
					{VARIABLE max_hench 4}
				[/case]
				[case]
					value=3
					{VARIABLE max_hench 3}
				[/case]
				[case]
					value=4
					{VARIABLE max_hench 2}
				[/case]
				[else]
					{VARIABLE max_hench 1}
				[/else]
			[/switch]
			{CLEAR_VARIABLE hench_num_query}
			[store_unit]
				variable=hench_query
				[filter]
					side=$side_number
					[not]
						canrecruit=yes
					[/not]
					[filter_wml]
						[variables]
							is_hench=1
						[/variables]
					[/filter_wml]
				[/filter]
			[/store_unit]
			{VARIABLE hench_number 0}
			[for]
				array=hench_query
				variable=i
				[do]
					{VARIABLE_OP hench_number add 1}
				[/do]
			[/for]
			{CLEAR_VARIABLE hench_query}
			[store_unit]
				variable=current_unit
				[filter]
					side=$side_number
					canrecruit=yes
					x,y=$x1,$y1
				[/filter]
			[/store_unit]
			{VARIABLE in_shop 1}
			[while]
				[variable]
					name=in_shop
					greater_than=0
				[/variable]
				[do]
					{CLEAR_VARIABLE tavern_insert}
					[for]
						array=tavern.hench
						variable=i
						[do]
							{VARIABLE tavern.hench[$i].variables.cost $tavern.hench[$i].variables.absolute_value}
							{VARIABLE_OP tavern.hench[$i].variables.cost multiply 3}
							{VARIABLE_OP tavern.hench[$i].variables.cost add $tavern.hench[$i].variables.equipment_value}
							{VARIABLE_OP tavern.hench[$i].variables.cost multiply .8}
							{VARIABLE_OP tavern.hench[$i].variables.cost round 0}
							{RED_COST "tavern.hench[$i].variables.cost"}
							{CLEAR_VARIABLE hench_abilities_list,hench_abilities}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.heals) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.heals[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.regenerate) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.regenerate[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.resistance) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.resistance[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.leadership) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.leadership[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.skirmisher) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.skirmisher[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.illuminates) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.illuminates[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.teleport) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.teleport[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.hides) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.hides[$macro_i].name
									[/value]
								[/set_variables]
							)}
							{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].abilities.dummy) (
								[set_variables]
									name=hench_abilities_list
									mode=append
									[value]
										name=$tavern.hench[$i].abilities.dummy[$macro_i].name
									[/value]
								[/set_variables]
							)}
							[if]
								[variable]
									name=hench_abilities_list.length
									greater_than=0
								[/variable]
								[then]
									[set_variable]
										name=hench_abilities
										[join]
											variable=hench_abilities_list
											key=name
											separator=", "
										[/join]
									[/set_variable]
									{VARIABLE hench_abilities_abstract $hench_abilities}
									{VARIABLE hench_abilities "Abilities: $hench_abilities_abstract
"}
								[/then]
							[/if]
							{CLEAR_VARIABLE hench_attack_insert}
							[for]
								array=tavern.hench[$i].attack
								variable=o
								[do]
									{CLEAR_VARIABLE hench_attack_special_list,hench_attack_special}
									[if]
										[variable]
											name=o
											less_than=1
										[/variable]
										[then]
											{VARIABLE hench_attack_insert "	$tavern.hench[$i].attack[$o].damage|-$tavern.hench[$i].attack[$o].number $tavern.hench[$i].attack[$o].description - $tavern.hench[$i].attack[$o].range $tavern.hench[$i].attack[$o].type
"}
										[/then]
										[else]
											{VARIABLE hench_attack_insert_abstract $hench_attack_insert}
											{VARIABLE hench_attack_insert "$hench_attack_insert_abstract|	$tavern.hench[$i].attack[$o].damage|-$tavern.hench[$i].attack[$o].number $tavern.hench[$i].attack[$o].description - $tavern.hench[$i].attack[$o].range $tavern.hench[$i].attack[$o].type
"}
										[/else]
									[/if]
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.chance_to_hit) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.chance_to_hit[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.damage) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.damage[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.attacks) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.attacks[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.slow) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.slow[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.poison) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.poison[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.petrifies) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.petrifies[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.berserk) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.berserk[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.firststrike) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.firststrike[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.drains) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.drains[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.plague) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.plague[$macro_i].name
											[/value]
										[/set_variables]
									)}
									{FILTER_ABILITY_NON_SPECIFIC (tavern.hench[$i].attack[$o].specials.dummy) (
										[set_variables]
											name=hench_attack_special_list
											mode=append
											[value]
												name=$tavern.hench[$i].attack[$o].specials.dummy[$macro_i].name
											[/value]
										[/set_variables]
									)}
									[if]
										[variable]
											name=hench_attack_special_list.length
											greater_than=0
										[/variable]
										[then]
											[set_variable]
												name=hench_attack_special
												[join]
													variable=hench_attack_special_list
													key=name
													separator=", "
												[/join]
											[/set_variable]
											{VARIABLE hench_attack_insert_abstract $hench_attack_insert}
											{VARIABLE hench_attack_insert "$hench_attack_insert_abstract|		<small>Specials: $hench_attack_special</small>
"}
										[/then]
									[/if]
								[/do]
							[/for]
							{VARIABLE arcane_insert "$(0$tavern.hench[$i].resistance.arcane*-1+100)"}
							{VARIABLE blade_insert "$(0$tavern.hench[$i].resistance.blade*-1+100)"}
							{VARIABLE fire_insert "$(0$tavern.hench[$i].resistance.fire*-1+100)"}
							{VARIABLE cold_insert "$(0$tavern.hench[$i].resistance.cold*-1+100)"}
							{VARIABLE impact_insert "$(0$tavern.hench[$i].resistance.impact*-1+100)"}
							{VARIABLE pierce_insert "$(0$tavern.hench[$i].resistance.pierce*-1+100)"}
							{VARIABLE flat_insert "$(0$tavern.hench[$i].defense.flat*-1+100)"}
							{VARIABLE hills_insert "$(0$tavern.hench[$i].defense.hills*-1+100)"}
							{VARIABLE forest_insert "$(0$tavern.hench[$i].defense.forest*-1+100)"}
							{VARIABLE mountains_insert "$(0$tavern.hench[$i].defense.mountains*-1+100)"}
							{VARIABLE swamp_water_insert "$(0$tavern.hench[$i].defense.swamp_water*-1+100)"}
							[set_variables]
								name=tavern_insert
								mode=append
								[value]
									label=_ "<span color='green'>$tavern.hench[$i].name|</span>
Level: $tavern.hench[$i].level|, Hitpoints: $tavern.hench[$i].max_hitpoints|, Moves: $tavern.hench[$i].max_moves|, Align: $tavern.hench[$i].alignment
<small><small>Resistances: $arcane_insert|% arcane, $blade_insert|% blade, $fire_insert|% fire, $cold_insert|% cold, $impact_insert|% impact, $pierce_insert|% pierce</small></small>
<small>Movement Costs / Terrain Defense: 
	<small>flat: $tavern.hench[$i].movement_costs.flat| / $flat_insert|, hills: $tavern.hench[$i].movement_costs.hills| / $hills_insert|, forest: $tavern.hench[$i].movement_costs.forest| / $forest_insert|, mountain: $tavern.hench[$i].movement_costs.mountains| / $mountains_insert|, swamp: $tavern.hench[$i].movement_costs.swamp_water| / $swamp_water_insert </small></small>
$hench_abilities|Attacks:
<small>$hench_attack_insert</small>
"
									description=_"$red_cost|$tavern.hench[$i].variables.cost|$red_cost2|"
									image=$tavern.hench[$i].image|~TC($side_number,magenta)
									[command]
										[if]
											[variable]
												name=current_unit.variables.personal_gold
												less_than=$tavern.hench[$i].variables.cost
											[/variable]
											[then]
												[message]
													speaker=narrator
													message=_ "You do not have enough gold to hire that henchman!"
													image=wesnoth-icon.png
												[/message]
											[/then]
											[else]
												[if]
													[variable]
														name=hench_number
														greater_than_equal_to=$max_hench
													[/variable]
													[then]
														[message]
															speaker=narrator
															message=_ "You already have the maximum amount of henchman! Release one to recruit another."
															image=wesnoth-icon.png
														[/message]
														{VARIABLE in_shop 0}
													[/then]
													[else]
														{VARIABLE_OP current_unit.variables.personal_gold sub $tavern.hench[$i].variables.cost}
														{VARIABLE tavern.hench[$i].variables.sp_side $current_unit.variables.sp_side}
														{VARIABLE tavern.hench[$i].side $current_unit.side}
														{VARIABLE tavern.hench[$i].variables.is_hench 1}
														{VARIABLE tavern.hench[$i].overlays "misc/hero-icon.png"}
														{VARIABLE tavern.hench[$i].upkeep 0}
														[unstore_unit]
															variable=tavern.hench[$i]
															x=1
															y=1
														[/unstore_unit]
														{TELEPORT_TILE 1 1 $current_unit.x $current_unit.y}
														[unstore_unit]
															variable=current_unit
														[/unstore_unit]
														{VARIABLE in_shop 0}
														{CLEAR_VARIABLE "tavern.hench[$i]"}
													[/else]
												[/if]
											[/else]
										[/if]
									[/command]
								[/value]
							[/set_variables]
						[/do]
					[/for]
					[if]
						[variable]
							name=max_hench
							numerical_not_equals=1
						[/variable]
						[then]
							{VARIABLE plural_hench "e"}
						[/then]
						[else]
							{VARIABLE plural_hench "a"}
						[/else]
					[/if]
					[message]
						image=$shop_names.tavern3
						speaker=narrator
						message= _ "In $shop_names.tavern|'s $shop_names.tavern2| you may hire $max_hench henchm$plural_hench|n at a time.
<small>Right-click to "Release Henchman"
You have $current_unit.variables.personal_gold| gold to spend. Who will you take with you?</small>"
						[option]
							label=_ "End purchase."
							image=check.png
							[command]
								{VARIABLE in_shop 0}
							[/command]
						[/option]
						[insert_tag]
							name=option
							variable=tavern_insert
						[/insert_tag]
						image=wesnoth-icon.png
					[/message]
					[modify_side]
						side=$current_unit.side
						gold=$current_unit.variables.personal_gold
					[/modify_side]
				[/do]
			[/while]
		[/command]
	[/set_menu_item]
	[event]
		name=scenario_end
		[clear_menu_item]
			id=a_wesband_tavern
		[/clear_menu_item]
	[/event]
#enddef

#store utils

#define SHOP_DIVIDER_MELEE_WEAPONS
	[option]
		label=_ "Weapons: Melee"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_RANGED_WEAPONS
	[option]
		label=_ "Weapons: Ranged"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
	[option]
		{DISPLAY_WEAPON (current_unit.variables.inventory.weapons.ranged[$current_unit.variables.equipment_slots.ranged])}
		description=_"<small><small>equipped</small></small>"
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_TORSO_ARMOR
	[option]
		label=_ "Armour: Torso"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
	[option]
		{DISPLAY_TORSO_ARMOR (current_unit.variables.inventory.armor.torso[$current_unit.variables.equipment_slots.torso_armor])}
		description=_"<small><small>equipped</small></small>"
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_LEG_ARMOR
	[option]
		label=_ "Armour: Leg"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
	[option]
		{DISPLAY_LEGS_ARMOR (current_unit.variables.inventory.armor.legs[$current_unit.variables.equipment_slots.leg_armor])}
		description=_"<small><small>equipped</small></small>"
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_HEAD_ARMOR
	[option]
		label=_ "Armour: Head"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
	[option]
		{DISPLAY_HEAD_ARMOR (current_unit.variables.inventory.armor.head[$current_unit.variables.equipment_slots.head_armor])}
		description=_"<small><small>equipped</small></small>"
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_SCROLLS
	[option]
		label=_ "Scrolls"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_TOMES
	[option]
		label=_ "Tomes"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_WANDS
	[option]
		label=_ "Wands"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_POTIONS
	[option]
		label=_ "Potions"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
#enddef

#define SHOP_DIVIDER_SHIELDS
	[option]
		label=_ "Armour: Shields"
		description=_ "<small><small>cost</small></small>"
		image=misc/blank-hex.png
		[command]
		[/command]
	[/option]
	[option]
		{DISPLAY_SHIELD (current_unit.variables.inventory.armor.shield[$current_unit.variables.equipment_slots.shield])}
		description=_"<small><small>equipped</small></small>"
		[command]
		[/command]
	[/option]
#enddef

#define CREATE_MAGIC_INSERT_TO_SHOP WHAT STRONG_TO_WEAK_RATIO
	{VARIABLE max_rank $dungeon_level.max|}

	# One in {STRONG_TO_WEAK_RATIO} items will have a max level of the
	# $dungeon_level.max, the rest three levels lower.
	{RANDOM 1..{STRONG_TO_WEAK_RATIO}}
	{IF_VAR random greater_than 1 (
		[then]
			{VARIABLE_OP max_rank sub 3}
			{IF_VAR max_rank less_than 0 (
				[then]
					{VARIABLE max_rank 0}
				[/then]
			)}
		[/then]
	)}
	{VARIABLE_OP new_item_rank rand 0..$max_rank|}
	{RANDOM 0..2}
	{VARIABLE_OP new_item_rank add $random}
	{RANDOM_MAGIC {WHAT} prob_overworld_shop_{WHAT} $new_item_rank magic_shop.{WHAT}s[$magic_shop.{WHAT}s.length]}
#enddef

#define CREATE_POTION_INSERT_TO_SHOP
	{CREATE_MAGIC_INSERT_TO_SHOP potion 4}
#enddef

#define CREATE_SCROLL_INSERT_TO_SHOP
	{CREATE_MAGIC_INSERT_TO_SHOP scroll 4}
#enddef

#define CREATE_TOME_INSERT_TO_SHOP
	{CREATE_MAGIC_INSERT_TO_SHOP tome 4}
#enddef

#define CREATE_HENCH_INSERT_TO_TAVERN
	[if]
		[variable]
			name=dungeon_level.max
			less_than=2
		[/variable]
		[then]
			#{VARIABLE_OP new_hench rand "WBD Orcish Assassin,WBD Lich,WBD Spearman,WBD Elvish Druid"}
			{VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.max
			less_than=4
		[/variable]
		[not]
			[variable]
				name=dungeon_level.max
				less_than=2
			[/variable]
		[/not]
		[then]
			{VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.max
			less_than=6
		[/variable]
		[not]
			[variable]
				name=dungeon_level.max
				less_than=4
			[/variable]
		[/not]
		[then]
			{VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant,WBD Dwarvish Steelclad,WBD Dwarvish Stalwart,WBD Dwarvish Thunderguard,WBD Dwarvish Berserker,WBD Elvish Marksman,WBD Elvish Ranger,WBD Elvish Captain,WBD Elvish Hero,WBD Elvish Druid,WBD Elvish Sorceress,WBD Duelist,WBD Shock Trooper,WBD Red Mage,WBD White Mage,WBD Longbowman,WBD Javelineer,WBD Pikeman,WBD Swordsman,WBD Outlaw,WBD Bandit,WBD Lieutenant,WBD Rogue,WBD Trapper"}
		[/then]
	[/if]
	[if]
		[variable]
			name=dungeon_level.max
			greater_than_equal_to=6
		[/variable]
		[then]
			{VARIABLE_OP new_hench rand "WBD Woodsman,WBD Ruffian,WBD Peasant,WBD Brute,WBD Civilian,WBD Initiate,WBD Nobleman,WBD Elf,WBD She Elf,WBD Dwarvish Fighter,WBD Dwarvish Guardsman,WBD Dwarvish Thunderer,WBD Dwarvish Ulfserker,WBD Elvish Archer,WBD Elvish Fighter,WBD Elvish Shaman,WBD Fencer,WBD Heavy Infantryman,WBD Mage,WBD Bowman,WBD Spearman,WBD Footpad,WBD Thug,WBD Thief,WBD Poacher,WBD Sergeant,WBD Dwarvish Steelclad,WBD Dwarvish Stalwart,WBD Dwarvish Thunderguard,WBD Dwarvish Berserker,WBD Elvish Marksman,WBD Elvish Ranger,WBD Elvish Captain,WBD Elvish Hero,WBD Elvish Druid,WBD Elvish Sorceress,WBD Duelist,WBD Shock Trooper,WBD Red Mage,WBD White Mage,WBD Longbowman,WBD Javelineer,WBD Pikeman,WBD Swordsman,WBD Outlaw,WBD Bandit,WBD Lieutenant,WBD Rogue,WBD Trapper,WBD Dwarvish Lord,WBD Dwarvish Sentinel,WBD Dwarvish Dragonguard,WBD Elvish Sharpshooter,WBD Elvish Avenger,WBD Elvish Marshal,WBD Elvish Champion,WBD Elvish Shyde,WBD Elvish Enchantress,WBD Master at Arms,WBD Iron Mauler,WBD Arch Mage,WBD Mage of Light,WBD Master Bowman,WBD Halberdier,WBD Royal Guard,WBD Royal Warrior,WBD Fugitive,WBD Highwayman,WBD General,WBD Assassin,WBD Huntsman,WBD Ranger"}
		[/then]
	[/if]

	[unit]
		side="$(1+$const.max_player_count)"
		type=$new_hench
		x=1
		y=1
		generate_name=yes
		random_traits=yes
		random_gender=yes
		generate_name=yes
		[status]
			construct_unit=yes
		[/status]
	[/unit]
	[store_unit]
		variable=tavern.hench
		mode=append
		[filter]
			x,y=1,1
		[/filter]
		kill=yes
	[/store_unit]
	{VARIABLE z $tavern.hench.length}
	{VARIABLE_OP z sub 1}
	{VARIABLE tavern.hench[$z].variables.sp_side $tavern.hench[$z].side}
	{CREATE_NPC "tavern.hench[$z]"}
	{VARIABLE unit_path "tavern.hench[$z]"}
	{NPC_RACE_BASE "tavern.hench[$z]"}
	[fire_event]
		name=npc_apply_traits
	[/fire_event]
	[fire_event]
		name=npc_apply_items
	[/fire_event]
	[construct_unit]
		variable=tavern.hench[$z]
	[/construct_unit]
	[kill]
		x,y=1,1
	[/kill]
#enddef
