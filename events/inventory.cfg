#ifdef CAMPAIGN_WESBAND_Z_SP
[event]
	name=select
	first_time_only=no
	[if]
		[variable]
			name=in_dungeon
			equals=1
		[/variable]
		[variable]
			name=unit.variables.personal_gold
			not_equals=""
		[/variable]
		[then]
			[modify_side]
				side=$unit.side
				gold=$unit.variables.personal_gold
			[/modify_side]
		[/then]
	[/if]
[/event]
#endif

[event]
	name=wbd manage equipment
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "equipment change")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{SBD_WEAPON_MENU menu.insert current.unit "wbd manage slot" 1}
			{SBD_ARMOR_MENU  menu.insert current.unit "wbd manage slot" 1 1}
			{WBD_PAPERDOLL_CALCS}
			[message]
				speaker=narrator
				side_for=$side_number
				{WBD_DISPLAY_PAPERDOLL}

				[option]
					label=_ "(Done - accept current equipment)"
					image=check.png
					[show_if]
						[variable]
							name=current.action.expended
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[option]
					label=_ "(Done - using original equipment)"
					image=check.png
					[show_if]
						[variable]
							name=current.action.expended
							less_than=2
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "(Cancel - undo latest changes)"
					image=check.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd manage slot
	first_time_only=no
#{UNIT}
#{UNIT}.variables.inventory.
	{VARIABLE menu.inv.var $menu.unit_path|.variables.inventory.$menu.slot.type}
	{VARIABLE menu.slot.var $menu.unit_path|.variables.equipment_slots.$menu.slot.id}
	{VARIABLE menu.cancel_id $$menu.slot.var}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			[switch]
				variable=menu.slot.id
				[case]
					value=shield
					{VARIABLE menu.message (_ "Select Shield (Currently Equipped At Top)")}
					[set_variables]
						name=menu.insert
						mode=replace
						[value]
							{DISPLAY_SHIELD $menu.inv.var|[$$menu.slot.var]}
						[/value]
					[/set_variables]
					[for]
						array=$menu.inv.var|
						variable=i
						[do]
							{IF_VAR $menu.slot.var not_equals $i (
								[then]
									[set_variables]
										name=menu.insert
										mode=append
										[value]
											{DISPLAY_SHIELD $menu.inv.var|[$i]}
											[command]
												{VARIABLE $menu.slot.var $i}
												[construct_unit]
													variable=$menu.unit_path|
												[/construct_unit]
											[/command]
										[/value]
									[/set_variables]
								[/then]
							)}
						[/do]
					[/for]
				[/case]
				[case]
					value=head_armor
					{VARIABLE menu.message (_ "Select head armor (currently equipped at top)")}
					[describe_item]
						item=current.unit.variables.inventory.armor.head[$current.unit.variables.equipment_slots.head_armor]
						dest=menu.insert
						mode=replace
					[/describe_item]
					[for]
						array=$menu.inv.var|
						variable=i
						[do]
							{IF_VAR $menu.slot.var not_equals $i (
								[then]
									# [describe_item]
									#     item=$menu.inv.var|[$i]
									#     name=menu.insert
									#     mode=append
									#     tag=option
									#     [command]
									#         {VARIABLE $menu.slot.var $i}
									#         [construct_unit]
									#             variable=$menu.unit_path|
									#         [/construct_unit]
									#     [/command]
									# [/describe_item]
									[describe_item]
										item=$menu.inv.var|[$i]
										dest=menu.insert
										mode=append
										[command]
											{VARIABLE $menu.slot.var $i}
											[construct_unit]
												variable=$menu.unit_path|
											[/construct_unit]
										[/command]
									[/describe_item]
								[/then]
							)}
						[/do]
					[/for]
				[/case]
				[case]
					value=torso_armor
					{VARIABLE menu.message (_ "Select torso armor (currently equipped at top)")}
					[describe_item]
						item=$menu.inv.var|[$$menu.slot.var]
						dest=menu.insert
						mode=replace
					[/describe_item]
					[for]
						array=$menu.inv.var|
						variable=i
						[do]
							{IF_VAR $menu.slot.var not_equals $i (
								[then]
									[describe_item]
										item=$menu.inv.var|[$i]
										dest=menu.insert
										mode=append
										[command]
											{VARIABLE $menu.slot.var $i}
											[construct_unit]
												variable=$menu.unit_path|
											[/construct_unit]
										[/command]
									[/describe_item]
								[/then]
							)}
						[/do]
					[/for]
				[/case]
				[case]
					value=leg_armor
					{VARIABLE menu.message (_ "Select leg armor (currently equipped at top)")}
					[describe_item]
						item=$menu.inv.var|[$$menu.slot.var]
						dest=menu.insert
						mode=replace
					[/describe_item]
					[for]
						array=$menu.inv.var|
						variable=i
						[do]
							{IF_VAR $menu.slot.var not_equals $i (
								[then]
									[describe_item]
										item=$menu.inv.var|[$i]
										dest=menu.insert
										mode=append
										[command]
											{VARIABLE $menu.slot.var $i}
											[construct_unit]
												variable=$menu.unit_path|
											[/construct_unit]
										[/command]
									[/describe_item]
								[/then]
							)}
						[/do]
					[/for]
				[/case]
				[else]
					[switch]
						variable=menu.slot.var
						[case]
							value=melee_1
							{VARIABLE menu.message (_ "Select primary melee weapon (currently equipped at top)")}
						[/case]
						[case]
							value=melee_2
							{VARIABLE menu.message (_ "Select secondary melee weapon (currently equipped at top)")}
						[/case]
						[case]
							value=melee_3
							{VARIABLE menu.message (_ "Select tertiary melee weapon (currently equipped at top)")}
						[/case]
						[else]
							{VARIABLE menu.message (_ "Select ranged weapon (currently equipped at top)")}
						[/else]
					[/switch]
					{VARIABLE unit_path $menu.unit_path|}
					# [calculate_weapon_display]
					#     unit_variable=$menu.unit_path|
					#     weapon_variable=$menu.inv.var|[$$menu.slot.var]
					# [/calculate_weapon_display]
					[describe_item]
						item=$menu.inv.var|[$$menu.slot.var]
						unit=$menu.unit_path|
						dest=menu.insert
						mode=replace
						# [value]
						#     {WBD_DISPLAY_WEAPON $menu.inv.var|[$$menu.slot.var] $display_damage| $display_number|}
						# [/value]
					[/describe_item]
					{VARIABLE unit_path $menu.unit_path|}
					[for]
						array=$menu.inv.var|
						variable=i
						[do]
							{IF_VAR $menu.slot.var not_equals $i (
								[then]
									[describe_item]
										item=$menu.inv.var|[$i]
										unit=$menu.unit_path|
										dest=menu.insert
										mode=append
										[command]
											{VARIABLE $menu.slot.var $i}
											[construct_unit]
												variable=$menu.unit_path|
											[/construct_unit]
										[/command]
									[/describe_item]
								[/then]
							)}
						[/do]
					[/for]
				[/else]
			[/switch]
			[message]
				speaker=narrator
				side_for=$side_number
				message=$menu.message
				[option]
					label=_ "(Accept equipment)"
					image=check.png
					[command]
						{IF_VAR $menu.unit_path|.variables.inventory.armor.torso[$$menu.unit_path|.variables.equipment_slots.torso_armor].restricts.head greater_than 0 (
							[then]
								{VARIABLE $menu.unit_path|.variables.equipment_slots.head_armor 0}
							[/then]
						)}
						{IF_VAR $menu.unit_path|.variables.inventory.armor.torso[$$menu.unit_path|.variables.equipment_slots.torso_armor].restricts.legs greater_than 0 (
							[then]
								{VARIABLE $menu.unit_path|.variables.equipment_slots.leg_armor 0}
							[/then]
						)}
						{IF_VAR $menu.unit_path|.variables.inventory.armor.torso[$$menu.unit_path|.variables.equipment_slots.torso_armor].restricts.shield greater_than 0 (
							[then]
								{VARIABLE $menu.unit_path|.variables.equipment_slots.shield 0}
							[/then]
						)}
						{IF_VAR $menu.unit_path|.variables.inventory.armor.shield[$$menu.unit_path|.variables.equipment_slots.shield].block_wield greater_than 1 (
							[then]
								{VARIABLE $menu.unit_path|.variables.equipment_slots.melee_2 0}
							[/then]
						)}
						{IF_VAR $menu.unit_path|.variables.inventory.armor.shield[$$menu.unit_path|.variables.equipment_slots.shield].block_wield greater_than 0 (
							[then]
								{VARIABLE $menu.unit_path|.variables.equipment_slots.melee_3 0}
							[/then]
						)}
						[if]
							[variable]
								name=$menu.unit_path|.variables.equipment_slots.melee_1
								not_equals=$current.start_equip.primary
							[/variable]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.melee_2
									not_equals=$current.start_equip.secondary
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.melee_3
									not_equals=$current.start_equip.tertiary
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.ranged
									not_equals=$current.start_equip.ranged
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.shield
									not_equals=$current.start_equip.shield
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.head_armor
									not_equals=$current.start_equip.head
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.torso_armor
									not_equals=$current.start_equip.torso
								[/variable]
							[/or]
							[or]
								[variable]
									name=$menu.unit_path|.variables.equipment_slots.leg_armor
									not_equals=$current.start_equip.legs
								[/variable]
							[/or]
							[then]
								{IF_VAR current.action.expended less_than 2 (
									[then]
										{VARIABLE_OP current.action.expended add 2}
									[/then]
								)}
							[/then]
							[else]
								{IF_VAR current.action.expended greater_than 1 (
									[then]
										{VARIABLE_OP current.action.expended sub 2}
									[/then]
								)}
							[/else]
						[/if]
						{IF_VAR $menu.slot.var not_equals $menu.cancel_id (
							[then]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "(Cancel equipment change)"
					image=x.png
					[command]
						{IF_VAR $menu.slot.var not_equals $menu.cancel_id (
							[then]
								{VARIABLE $menu.slot.var $menu.cancel_id}
								[construct_unit]
									variable=$menu.unit_path|
								[/construct_unit]
							[/then]
						)}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd view slot
	first_time_only=no

	[sound]
		name=goblin-hit-3.ogg
	[/sound]
[/event]

[event]
	name=wbd view equipment
	first_time_only=no

	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{SBD_WEAPON_MENU menu.insert current.unit "wbd view slot" 1}
			{SBD_ARMOR_MENU  menu.insert current.unit "wbd view slot" 1 1}
			{WBD_PAPERDOLL_CALCS}
			[message]
				speaker=narrator
				side_for=$side_number
				{WBD_DISPLAY_PAPERDOLL}

				[option]
					label=_ "(Back)"
					image=check.png
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{CANCEL_ACTION current.unit}
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd thunderstick tinker
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "tinkering")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			[for]
				array=current.unit.variables.inventory.weapons.ranged
				variable=i
				[do]
					{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].user_name equals thunderstick (
						[then]
							{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].ts_level less_than $current.unit.variables.abilities.thunderstick_tinker (
								[then]
									[set_variables]
										name=menu.insert
										mode=append
										[value]
											image=attacks/$current.unit.variables.inventory.weapons.ranged[$i].icon|.png
											label=_ "$current.unit.variables.inventory.weapons.ranged[$i].description|
<small>Damage: $current.unit.variables.inventory.weapons.ranged[$i].damage|, Shots: $current.unit.variables.inventory.weapons.ranged[$i].number|, Level: $current.unit.variables.inventory.weapons.ranged[$i].ts_level|</small>"
										[/value]
									[/set_variables]
									[set_variables]
										name=menu.insert
										mode=append
										[value]
											label=_ "Add 25% to damage."
											[command]
												{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].damage multiply 1.25}
												{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].max_damage multiply 1.25}
												{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].ts_level add 1}
												{IF_VAR current.unit.variables.equipment_slots.ranged equals $i (
													[then]
														[construct_unit]
															variable=current.unit
														[/construct_unit]
													[/then]
												)}
												{VARIABLE menu.action_flag 1}
											[/command]
										[/value]
									[/set_variables]
									{IF_VAR current.unit.variables.inventory.weapons.ranged[$i].damage greater_than_equal_to 20 (
										[then]
											[set_variables]
												name=menu.insert
												mode=append
												[value]
													label=_ "Double the shots and halve the damage."
													[command]
														{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].number multiply 2}
														{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].damage multiply .5}
														{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].max_damage multiply .5}
														{VARIABLE_OP current.unit.variables.inventory.weapons.ranged[$i].ts_level add 1}
														{IF_VAR current.unit.variables.equipment_slots.ranged equals $i (
															[then]
																[construct_unit]
																	variable=current.unit
																[/construct_unit]
															[/then]
														)}
														{VARIABLE menu.action_flag 1}
													[/command]
												[/value]
											[/set_variables]
										[/then]
										[else]
											[set_variables]
												name=menu.insert
												mode=append
												[value]
													label=_ "Damage is too low to increase number of shots."
												[/value]
											[/set_variables]
										[/else]
									)}
								[/then]
								[else]
									[set_variables]
										name=menu.insert
										mode=append
										[value]
											image=attacks/$current.unit.variables.inventory.weapons.ranged[$i].icon|.png
											label=_ "$current.unit.variables.inventory.weapons.ranged[$i].description|
<small>Damage: $current.unit.variables.inventory.weapons.ranged[$i].damage|, Shots: $current.unit.variables.inventory.weapons.ranged[$i].number|, Level: $current.unit.variables.inventory.weapons.ranged[$i].ts_level|
Requires upgrade to tinker skill</small>"
										[/value]
									[/set_variables]
								[/else]
							)}
						[/then]
					)}
				[/do]
			[/for]
			[message]
				speaker=narrator
				side_for=$side_number
				message= _ "You can improve thundersticks that are under level $current.unit.variables.abilities.thunderstick_tinker|. You may either add 25% to the damage or double the number of shots in combat but this cuts their damage in half.
You may not decrease the damage below 10."
				[option]
					label=_ "(Done - Accept Changes)"
					image=check.png
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "(Cancel - Undo Latest Changes)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd get items
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "item pickup")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			[for]
				array=ground.x$menu.location.x|.y$menu.location.y|.items
				variable=i
				[do]
					[switch]
						variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i].category
						[case]
							value=melee_weapon
							{VARIABLE unit_path current.unit}
							[calculate_weapon_display]
								unit_variable=current.unit
								weapon_variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
							[/calculate_weapon_display]
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									{WBD_DISPLAY_WEAPON ground.x$menu.location.x|.y$menu.location.y|.items[$i] $display_damage| $display_number|}
									[command]
										[set_variables]
											name=current.unit.variables.inventory.weapons.melee
											mode=append
											[insert_tag]
												name=literal
												variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
											[/insert_tag]
										[/set_variables]
										[item_cleanup]
											x=$menu.location.x
											y=$menu.location.y
											index=$i
										[/item_cleanup]
										{VARIABLE menu.action_flag 1}
									[/command]
								[/value]
							[/set_variables]
						[/case]
						[case]
							value=ranged_weapon
							{VARIABLE unit_path current.unit}
							[calculate_weapon_display]
								unit_variable=current.unit
								weapon_variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
							[/calculate_weapon_display]
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									{WBD_DISPLAY_WEAPON ground.x$menu.location.x|.y$menu.location.y|.items[$i] $display_damage| $display_number|}
									[command]
										[set_variables]
											name=current.unit.variables.inventory.weapons.ranged
											mode=append
											[insert_tag]
												name=literal
												variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
											[/insert_tag]
										[/set_variables]
										{IF_VAR ground.x$menu.location.x|.y$menu.location.y|.items[$i].user_name equals thunderstick (
											[then]
												[construct_unit]
													variable=current.unit
												[/construct_unit]
											[/then]
										)}
										[item_cleanup]
											x=$menu.location.x
											y=$menu.location.y
											index=$i
										[/item_cleanup]
										{VARIABLE menu.action_flag 1}
									[/command]
								[/value]
							[/set_variables]
						[/case]
						[case]
							value=shield
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									{DISPLAY_SHIELD ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
									[command]
										[set_variables]
											name=current.unit.variables.inventory.armor.shield
											mode=append
											[insert_tag]
												name=literal
												variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
											[/insert_tag]
										[/set_variables]
										[item_cleanup]
											x=$menu.location.x
											y=$menu.location.y
											index=$i
										[/item_cleanup]
										{VARIABLE menu.action_flag 1}
									[/command]
								[/value]
							[/set_variables]
						[/case]
						[case]
							value=head_armor
							[describe_item]
								item=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
								dest=menu.insert
								mode=append
								# {DISPLAY_HEAD_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								# image=$value.image
								# label=$value.label
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.head
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/describe_item]
						[/case]
						[case]
							value=torso_armor
							[describe_item]
								item=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
								dest=menu.insert
								mode=append
								# # {DISPLAY_TORSO_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								# image=$value.image
								# label=$value.label
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.torso
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/describe_item]
						[/case]
						[case]
							value=legs_armor
							[describe_item]
								item=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
								dest=menu.insert
								mode=append
								# # {DISPLAY_LEGS_ARMOR ground.x$menu.location.x|.y$menu.location.y|.items[$i]}
								# image=$value.image
								# label=$value.label
								[command]
									[set_variables]
										name=current.unit.variables.inventory.armor.legs
										mode=append
										[insert_tag]
											name=literal
											variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
										[/insert_tag]
									[/set_variables]
									[item_cleanup]
										x=$menu.location.x
										y=$menu.location.y
										index=$i
									[/item_cleanup]
									{VARIABLE menu.action_flag 1}
								[/command]
							[/describe_item]
						[/case]
						[case]
							value=usables
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									image=$ground.x$menu.location.x|.y$menu.location.y|.items[$i].icon|.png
									label=_ "$ground.x$menu.location.x|.y$menu.location.y|.items[$i].description"
									[command]
										[set_variables]
											name=current.unit.variables.inventory.usables
											mode=append
											[insert_tag]
												name=literal
												variable=ground.x$menu.location.x|.y$menu.location.y|.items[$i]
											[/insert_tag]
										[/set_variables]
										[item_cleanup]
											x=$menu.location.x
											y=$menu.location.y
											index=$i
										[/item_cleanup]
										{VARIABLE menu.action_flag 1}
									[/command]
								[/value]
							[/set_variables]
						[/case]
						[case]
							value=gold
							[set_variables]
								name=menu.insert
								mode=append
								[value]
									image=$ground.x$menu.location.x|.y$menu.location.y|.items[$i].icon|.png
									label=_ "$ground.x$menu.location.x|.y$menu.location.y|.items[$i].description"
									[command]
										{WBD_ADD_GOLD current.unit current.leader $ground.x$menu.location.x|.y$menu.location.y|.items[$i].amount|}
										[item_cleanup]
											x=$menu.location.x
											y=$menu.location.y
											index=$i
										[/item_cleanup]
										{VARIABLE menu.action_flag 1}
									[/command]
								[/value]
							[/set_variables]
						[/case]
					[/switch]
				[/do]
			[/for]
			[message]
				speaker=narrator
				side_for=$side_number
				message= _ "Get which item?"
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[option]
					label=_ "Get all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=menu.insert.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						{WBD_INVENTORY_GET_ALL current.unit current.leader i $menu.location.x| $menu.location.y|}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
			{IF_VAR ground.x$menu.location.x|.y$menu.location.y|.items.length equals 0 (
				[then]
					{VARIABLE menu.level 0}
				[/then]
			)}
		[/do]
	[/while]
	[unstore_unit]
		variable=current.unit
	[/unstore_unit]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd give items
	first_time_only=no

	{CLEAR_VARIABLE menu.insert}
	[for]
		array=current.adjacent
		variable=i
		[do]
			[store_side]
				side=$current.adjacent[$i].side
				variable=menu.side_data
			[/store_side]
			[set_variables]
				name=menu.insert
				mode=append
				[value]
					image=$current.adjacent[$i].image|~TC($current.adjacent[$i].side,magenta)
					label=_ "$current.adjacent[$i].name ($current.adjacent[$i].language_name)"
					[command]
						{VARIABLE menu.recipient $i}
						{VARIABLE menu.level 1}
					[/command]
				[/value]
			[/set_variables]
		[/do]
	[/for]
	[message]
		speaker=narrator
		side_for=$side_number
		message=_ "Choose recipient"
		[insert_tag]
			name=option
			variable=menu.insert
		[/insert_tag]
		[option]
			label=_ "(Cancel)"
			image=x.png
		[/option]
		image=wesnoth-icon.png
	[/message]
	{IF_VAR menu.level equals 1 (
		[then]
			{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "give items")}
		[/then]
		[else]
			{VARIABLE menu.action_flag 2}
		[/else]
	)}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_give·}
			{VARIABLE unit_path current.adjacent[$menu.recipient]}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				[describe_item]
					item=current.unit.variables.inventory.weapons.melee[$i]
					unit=current.adjacent[$menu.recipient]
					dest=sorted_give
					mode=append
					[command]
						[set_variables]
							name=current.adjacent[$menu.recipient].variables.inventory.weapons.melee
							mode=append
							to_variable=current.unit.variables.inventory.weapons.melee[$i]
						[/set_variables]
						{CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
						{IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
							[/then]
						)}
						{IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
							[/then]
						)}
						{IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.primary equals $i (
							[then]
								{VARIABLE current.start_equip.primary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.secondary equals $i (
							[then]
								{VARIABLE current.start_equip.secondary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.tertiary equals $i (
							[then]
								{VARIABLE current.start_equip.tertiary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.primary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.primary sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.secondary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.secondary sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.tertiary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.tertiary sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
				# [calculate_weapon_display]
				#     unit_variable=current.adjacent[$menu.recipient]
				#     weapon_variable=current.unit.variables.inventory.weapons.melee[$i]
				# [/calculate_weapon_display]
				# [set_variables]
				#     name=sorted_give
				#     mode=append
				#     [value]
				#         {WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$i] $display_damage| $display_number|}
				#         [command]
				#             [set_variables]
				#                 name=current.adjacent[$menu.recipient].variables.inventory.weapons.melee
				#                 mode=append
				#                 to_variable=current.unit.variables.inventory.weapons.melee[$i]
				#             [/set_variables]
				#             {CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
				#             {IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.primary equals $i (
				#                 [then]
				#                     {VARIABLE current.start_equip.primary -1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.secondary equals $i (
				#                 [then]
				#                     {VARIABLE current.start_equip.secondary -1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.tertiary equals $i (
				#                 [then]
				#                     {VARIABLE current.start_equip.tertiary -1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.primary greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.start_equip.primary sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.secondary greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.start_equip.secondary sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.tertiary greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.start_equip.tertiary sub 1}
				#                 [/then]
				#             )}
				#             {VARIABLE menu.action_flag 1}
				#         [/command]
				#     [/value]
				# [/set_variables]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{VARIABLE unit_path current.adjacent[$menu.recipient]}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				[describe_item]
					item=current.unit.variables.inventory.weapons.ranged[$i]
					unit=current.adjacent[$menu.recipient]
					dest=sorted_give
					mode=append
					[command]
						[set_variables]
							name=current.adjacent[$menu.recipient].variables.inventory.weapons.ranged
							mode=append
							to_variable=current.unit.variables.inventory.weapons.ranged[$i]
						[/set_variables]
						{CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
						{IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.ranged equals $i (
							[then]
								{VARIABLE current.start_equip.ranged -1}
							[/then]
						)}
						{IF_VAR current.start_equip.ranged greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.ranged sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
				# [calculate_weapon_display]
				#     unit_variable=current.adjacent[$menu.recipient]
				#     weapon_variable=current.unit.variables.inventory.weapons.ranged[$i]
				# [/calculate_weapon_display]
				# [set_variables]
				#     name=sorted_give
				#     mode=append
				#     [value]
				#         {WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$i] $display_damage| $display_number|}
				#         [command]
				#             [set_variables]
				#                 name=current.adjacent[$menu.recipient].variables.inventory.weapons.ranged
				#                 mode=append
				#                 to_variable=current.unit.variables.inventory.weapons.ranged[$i]
				#             [/set_variables]
				#             {CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
				#             {IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.ranged equals $i (
				#                 [then]
				#                     {VARIABLE current.start_equip.ranged -1}
				#                 [/then]
				#             )}
				#             {IF_VAR current.start_equip.ranged greater_than $i (
				#                 [then]
				#                     {VARIABLE_OP current.start_equip.ranged sub 1}
				#                 [/then]
				#             )}
				#             {VARIABLE menu.action_flag 1}
				#         [/command]
				#     [/value]
				# [/set_variables]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				[set_variables]
					name=sorted_give
					mode=append
					[value]
						{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$i]}
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.shield
								mode=append
								to_variable=current.unit.variables.inventory.armor.shield[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.shield[$i]}
							{IF_VAR current.unit.variables.equipment_slots.shield greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.shield sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield equals $i (
								[then]
									{VARIABLE current.start_equip.shield -1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.shield sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				[describe_item]
					item=current.unit.variables.inventory.armor.head[$i]
					dest=sorted_give
					mode=append
					# # {DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$i]}
					# image=$value.image
					# label=$value.label
					[command]
						[set_variables]
							name=current.adjacent[$menu.recipient].variables.inventory.armor.head
							mode=append
							to_variable=current.unit.variables.inventory.armor.head[$i]
						[/set_variables]
						{CLEAR_VARIABLE current.unit.variables.inventory.armor.head[$i]}
						{IF_VAR current.unit.variables.equipment_slots.head_armor greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.head_armor sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.head equals $i (
							[then]
								{VARIABLE current.start_equip.head -1}
							[/then]
						)}
						{IF_VAR current.start_equip.head greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.head sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				[describe_item]
					item=current.unit.variables.inventory.armor.torso[$i]
					dest=sorted_give
					mode=append
					# # {DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$i]}
					# image=$value.image
					# label=$value.label
					[command]
						[set_variables]
							name=current.adjacent[$menu.recipient].variables.inventory.armor.torso
							mode=append
							to_variable=current.unit.variables.inventory.armor.torso[$i]
						[/set_variables]
						{CLEAR_VARIABLE current.unit.variables.inventory.armor.torso[$i]}
						{IF_VAR current.unit.variables.equipment_slots.torso_armor greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.torso_armor sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.torso equals $i (
							[then]
								{VARIABLE current.start_equip.torso -1}
							[/then]
						)}
						{IF_VAR current.start_equip.torso greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.torso sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				[describe_item]
					item=current.unit.variables.inventory.armor.legs[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_give
					mode=append
					[value]
						# {DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$i]}
						image=$value.image
						label=$value.label
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.armor.legs
								mode=append
								to_variable=current.unit.variables.inventory.armor.legs[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.legs[$i]}
							{IF_VAR current.unit.variables.equipment_slots.leg_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.leg_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs equals $i (
								[then]
									{VARIABLE current.start_equip.legs -1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.legs sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}
			{WBD_FOR_DROPPABLE current.unit usables (
				[set_variables]
					name=sorted_give
					mode=append
					[value]
						image=$current.unit.variables.inventory.usables[$i].icon|.png
						label=_ "$current.unit.variables.inventory.usables[$i].description"
						[command]
							[set_variables]
								name=current.adjacent[$menu.recipient].variables.inventory.usables
								mode=append
								to_variable=current.unit.variables.inventory.usables[$i]
							[/set_variables]
							{CLEAR_VARIABLE current.unit.variables.inventory.usables[$i]}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[wbd_sort_array]
				name=sorted_give
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_give
			[/set_variables]
			{CLEAR_VARIABLE sorted_give}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.adjacent[$menu.recipient]
						[/unstore_unit]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Transfer gold"
					image=icons/gold-give.png
					[show_if]
						[variable]
							name=current.unit.variables.personal_gold
							greater_than=0
						[/variable]
						[and]
							[variable]
								name=current.adjacent[$menu.recipient].canrecruit
								equals=yes
							[/variable]
						[/and]
					[/show_if]
					[command]
						{VARIABLE menu.header_message (_ "Transfer how much gold?")}
						{VARIABLE menu.accept_message (_ "(Transfer gold)")}
						{VARIABLE menu.cancel_message (_ "(Cancel gold transfer)")}
						{FIRE_EVENT "wbd gold input"}
						{IF_VAR menu.gold.amount greater_than 0 (
							[then]
								{VARIABLE_OP current.unit.variables.personal_gold sub $menu.gold.amount}
								{VARIABLE_OP current.adjacent[$menu.recipient].variables.personal_gold add $menu.gold.amount}
								[modify_side]
									side=$current.unit.side
									gold=$current.unit.variables.personal_gold
								[/modify_side]
								[modify_side]
									side=$current.adjacent[$menu.recipient].side
									gold=$current.adjacent[$menu.recipient].variables.personal_gold
								[/modify_side]
								[sound]
									name=gold.ogg
								[/sound]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	[switch]
		variable=menu.action_flag
		[case]
			value=1
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/case]
		[case]
			value=2
			{CLEAR_VARIABLE menu.action_flag}
		[/case]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	[/switch]
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd drop items
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items")}
	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				# [calculate_weapon_display]
				#     unit_variable=current.unit
				#     weapon_variable=current.unit.variables.inventory.weapons.melee[$i]
				# [/calculate_weapon_display]
				[describe_item]
					item=current.unit.variables.inventory.weapons.melee[$i]
					unit=current.unit
					dest=sorted_drop
					mode=append
					# {WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$i] $display_damage| $display_number|}
					[command]
						[drop_item]
							x=$menu.location.x
							y=$menu.location.y
							[insert_tag]
								name=item
								variable=current.unit.variables.inventory.weapons.melee[$i]
							[/insert_tag]
						[/drop_item]
						{CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
						{IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
							[/then]
						)}
						{IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
							[/then]
						)}
						{IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.primary equals $i (
							[then]
								{VARIABLE current.start_equip.primary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.secondary equals $i (
							[then]
								{VARIABLE current.start_equip.secondary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.tertiary equals $i (
							[then]
								{VARIABLE current.start_equip.tertiary -1}
							[/then]
						)}
						{IF_VAR current.start_equip.primary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.primary sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.secondary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.secondary sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.tertiary greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.tertiary sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				[calculate_weapon_display]
					unit_variable=current.unit
					weapon_variable=current.unit.variables.inventory.weapons.ranged[$i]
				[/calculate_weapon_display]
				[describe_item]
					item=current.unit.variables.inventory.weapons.ranged[$i]
					unit=current.unit
					dest=sorted_drop
					mode=append
					# {WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$i] $display_damage| $display_number|}
					[command]
						[drop_item]
							x=$menu.location.x
							y=$menu.location.y
							[insert_tag]
								name=item
								variable=current.unit.variables.inventory.weapons.ranged[$i]
							[/insert_tag]
						[/drop_item]
						{CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
						{IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.ranged equals $i (
							[then]
								{VARIABLE current.start_equip.ranged -1}
							[/then]
						)}
						{IF_VAR current.start_equip.ranged greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.ranged sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.shield[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.shield[$i]}
							{IF_VAR current.unit.variables.equipment_slots.shield greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.shield sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield equals $i (
								[then]
									{VARIABLE current.start_equip.shield -1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.shield sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				[describe_item]
					item=current.unit.variables.inventory.armor.head[$i]
					unit=current.unit
					dest=sorted_drop
					mode=append
					# # {DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$i]}
					# image=$value.image
					# label=$value.label
					[command]
						[drop_item]
							x=$menu.location.x
							y=$menu.location.y
							[insert_tag]
								name=item
								variable=current.unit.variables.inventory.armor.head[$i]
							[/insert_tag]
						[/drop_item]
						{CLEAR_VARIABLE current.unit.variables.inventory.armor.head[$i]}
						{IF_VAR current.unit.variables.equipment_slots.head_armor greater_than $i (
							[then]
								{VARIABLE_OP current.unit.variables.equipment_slots.head_armor sub 1}
							[/then]
						)}
						{IF_VAR current.start_equip.head equals $i (
							[then]
								{VARIABLE current.start_equip.head -1}
							[/then]
						)}
						{IF_VAR current.start_equip.head greater_than $i (
							[then]
								{VARIABLE_OP current.start_equip.head sub 1}
							[/then]
						)}
						{VARIABLE menu.action_flag 1}
					[/command]
				[/describe_item]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				[describe_item]
					item=current.unit.variables.inventory.armor.torso[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						# {DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$i]}
						image=$value.image
						label=$value.label
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.torso[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.torso[$i]}
							{IF_VAR current.unit.variables.equipment_slots.torso_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.torso_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso equals $i (
								[then]
									{VARIABLE current.start_equip.torso -1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.torso sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				[describe_item]
					item=current.unit.variables.inventory.armor.legs[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						# {DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$i]}
						image=$value.image
						label=$value.label
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.legs[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.legs[$i]}
							{IF_VAR current.unit.variables.equipment_slots.leg_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.leg_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs equals $i (
								[then]
									{VARIABLE current.start_equip.legs -1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.legs sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}
			{WBD_FOR_DROPPABLE current.unit usables (
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						image=$current.unit.variables.inventory.usables[$i].icon|.png
						label=_ "$current.unit.variables.inventory.usables[$i].description"
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.usables[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.usables[$i]}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "Drop gold"
					image=icons/gold-give.png
					[show_if]
						[variable]
							name=current.unit.variables.personal_gold
							greater_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.header_message (_ "Drop how much gold?")}
						{VARIABLE menu.accept_message (_ "(Drop gold)")}
						{VARIABLE menu.cancel_message (_ "(Cancel gold drop)")}
						{FIRE_EVENT "wbd gold input"}
						{IF_VAR menu.gold.amount greater_than 0 (
							[then]
								{VARIABLE_OP current.unit.variables.personal_gold sub $menu.gold.amount}
								[modify_side]
									side=$current.unit.side
									gold=$current.unit.variables.personal_gold
								[/modify_side]
								{DROP_GOLD menu.gold.amount $menu.location.x| $menu.location.y|}
								[sound]
									name=gold.ogg
								[/sound]
								{VARIABLE menu.action_flag 1}
							[/then]
						)}
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]

[event]
	name=wbd gold input
	first_time_only=no

	{VARIABLE menu.gold.amount 0}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{VARIABLE menu.gold.shifted_difference "$(10*0$menu.gold.amount-0$current.unit.variables.personal_gold)"}
			[message]
				speaker=narrator
				message="$menu.header_message| $menu.gold.amount|_"
				side_for=$side_number
				[option]
					label=$menu.accept_message
					image=check.png
					[show_if]
						[variable]
							name=menu.gold.amount
							greater_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				[option]
					label=_ "0"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=1
						[/variable]
						[and]
							[variable]
								name=menu.gold.amount
								greater_than=0
							[/variable]
						[/and]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
					[/command]
				[/option]
				[option]
					label=_ "1"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=0
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 1}
					[/command]
				[/option]
				[option]
					label=_ "2"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-1
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 2}
					[/command]
				[/option]
				[option]
					label=_ "3"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-2
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 3}
					[/command]
				[/option]
				[option]
					label=_ "4"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-3
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 4}
					[/command]
				[/option]
				[option]
					label=_ "5"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-4
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 5}
					[/command]
				[/option]
				[option]
					label=_ "6"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-5
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 6}
					[/command]
				[/option]
				[option]
					label=_ "7"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-6
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 7}
					[/command]
				[/option]
				[option]
					label=_ "8"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-7
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 8}
					[/command]
				[/option]
				[option]
					label=_ "9"
					[show_if]
						[variable]
							name=menu.gold.shifted_difference
							less_than=-8
						[/variable]
					[/show_if]
					[command]
						{VARIABLE_OP menu.gold.amount multiply 10}
						{VARIABLE_OP menu.gold.amount add 9}
					[/command]
				[/option]
				[option]
					label=$menu.cancel_message
					image=x.png
					[command]
						{VARIABLE menu.gold.amount 0}
						{VARIABLE menu.level 1}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
[/event]

[event]
	name=wbd inventory cancel stack pop
	first_time_only=no

	[set_variables]
		name=current
		mode=replace
		to_variable=cancel[$menu.cancel_ptr]
	[/set_variables]
	{CLEAR_VARIABLE cancel[$menu.cancel_ptr]}
	{VARIABLE_OP menu.cancel_ptr sub 1}
	[construct_unit]
		variable=current.unit
	[/construct_unit]
	{IF_VAR menu.construct_type equals pc (
		[then]
			[modify_side]
				side=$side_number
				gold=$current.unit.variables.personal_gold
			[/modify_side]
		[/then]
		[else]
			[unstore_unit]
				variable=current.leader
			[/unstore_unit]
			[modify_side]
				side=$side_number
				gold=$current.leader.variables.personal_gold
			[/modify_side]
		[/else]
	)}
	[for]
		array=current.adjacent
		variable=i
		[do]
			[unstore_unit]
				variable=current.adjacent[$i]
			[/unstore_unit]
			{IF_VAR current.adjacent[$i].canrecruit equals yes (
				[then]
					[modify_side]
						side=$current.adjacent[$i].side
						gold=$current.adjacent[$i].variables.personal_gold
					[/modify_side]
				[/then]
			)}
		[/do]
	[/for]
	[item_cleanup]
		x=$menu.location.x
		y=$menu.location.y
	[/item_cleanup]
	[for]
		array=current.ground
		variable=i
		[do]
			[drop_item]
				x=$menu.location.x
				y=$menu.location.y
				from_variable=current.ground[$i]
			[/drop_item]
		[/do]
	[/for]
[/event]

[event]
	name=wbd inventory cancel stack push
	first_time_only=no

	{VARIABLE_OP menu.cancel_ptr add 1}
	[set_variables]
		name=current.ground
		mode=replace
		to_variable=ground.x$menu.location.x|.y$menu.location.y|.items
	[/set_variables]
	[store_unit]
		variable=current.unit
		[filter]
			x=$menu.location.x
			y=$menu.location.y
		[/filter]
	[/store_unit]
	[store_unit]
		variable=current.adjacent
		[filter]
			side=$const.player_sides
			[not]
				type="WBD Unknown Adventurer"
			[/not]
			[filter_adjacent]
				id=$current.unit.id
			[/filter_adjacent]
			[and]
				canrecruit=yes
				[or]
					[not]
						race=undead
						type=Walking Corpse_MODRPG,Ghoul_MODRPG,Trapped Spirit
					[/not]
				[/or]
				[or]
					[filter_wml]
						corpse_type=skel
					[/filter_wml]
				[/or]
				[or]
					[filter_wml]
						[variables]
							[npc_init]
								corpse_type=skel
							[/npc_init]
						[/variables]
					[/filter_wml]
				[/or]
				[or]
					[filter_wml]
						[variables]
							[abilities]
								skeletal=1
							[/abilities]
						[/variables]
					[/filter_wml]
				[/or]
			[/and]
		[/filter]
	[/store_unit]
	{IF_VAR menu.construct_type equals npc (
		[then]
			[store_unit]
				variable=current.leader
				[filter]
					side=$side_number
					canrecruit=yes
				[/filter]
			[/store_unit]
		[/then]
	)}
	[set_variables]
		name=cancel
		mode=append
		to_variable=current
	[/set_variables]
[/event]

[event]
	name=wbd drop items category
	first_time_only=no

	{VARIABLE menu.level 1}
	[while]
		[variable]
			name=menu.level
			equals=1
		[/variable]
		[do]
			{VARIABLE menu.droppable 0}
			{VARIABLE menu.droppable_melee 0}
			{VARIABLE menu.droppable_ranged 0}
			{VARIABLE menu.droppable_head 0}
			{VARIABLE menu.droppable_shield 0}
			{VARIABLE menu.droppable_torso 0}
			{VARIABLE menu.droppable_legs 0}
			{VARIABLE menu.droppable_usables 0}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_melee 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_ranged 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_shield 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_head 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_torso 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_legs 1}
				[break][/break]
			)}
			{WBD_FOR_DROPPABLE current.unit usables (
				{VARIABLE menu.droppable 1}
				{VARIABLE menu.droppable_usables 1}
				[break][/break]
			)}

			{IF_VAR menu.droppable equals 1 (
				[then]
					[message]
						speaker=narrator
						side_for=$side_number
						[option]
							label=_ "(End)"
							image=check.png
							[command]
								#[unstore_unit]
								#    variable=current.unit
								#[/unstore_unit]
								{VARIABLE menu.level 0}
							[/command]
						[/option]
						[option]
							label=_ "Drop melee weapons"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_melee
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items melee"}
							[/command]
						[/option]
						[option]
							label=_ "Drop ranged weapons"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_ranged
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items ranged"}
							[/command]
						[/option]
						[option]
							label=_ "Drop head armor"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_head
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items head"}
							[/command]
						[/option]
						[option]
							label=_ "Drop shield armor"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_shield
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items shield"}
							[/command]
						[/option]
						[option]
							label=_ "Drop torso armor"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_torso
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items torso"}
							[/command]
						[/option]
						[option]
							label=_ "Drop legs armor"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_legs
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items legs"}
							[/command]
						[/option]
						[option]
							label=_ "Drop usables items"
							image=icons/item-drop.png
							[show_if]
								[variable]
									name=current.action.available
									greater_than=0
								[/variable]
								[and]
									[variable]
										name=menu.droppable_usables
										equals=1
									[/variable]
								[/and]
							[/show_if]
							[command]
								{FIRE_EVENT "wbd drop items usables"}
							[/command]
						[/option]
						image=wesnoth-icon.png
					[/message]
				[/then]
				[else]
					{VARIABLE menu.level 0}
				[/else]
			)}
			{CLEAR_VARIABLE menu.droppable}
			{CLEAR_VARIABLE menu.droppable_melee}
			{CLEAR_VARIABLE menu.droppable_ranged}
			{CLEAR_VARIABLE menu.droppable_head}
			{CLEAR_VARIABLE menu.droppable_shield}
			{CLEAR_VARIABLE menu.droppable_torso}
			{CLEAR_VARIABLE menu.droppable_legs}
			{CLEAR_VARIABLE menu.droppable_usables}
		[/do]
	[/while]
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items melee
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items melee")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.melee (
				[calculate_weapon_display]
					unit_variable=current.unit
					weapon_variable=current.unit.variables.inventory.weapons.melee[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.melee[$i] $display_damage| $display_number|}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.weapons.melee[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.melee[$i]}
							{IF_VAR current.unit.variables.equipment_slots.melee_1 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_1 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_2 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_2 sub 1}
								[/then]
							)}
							{IF_VAR current.unit.variables.equipment_slots.melee_3 greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.melee_3 sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary equals $i (
								[then]
									{VARIABLE current.start_equip.primary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary equals $i (
								[then]
									{VARIABLE current.start_equip.secondary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary equals $i (
								[then]
									{VARIABLE current.start_equip.tertiary -1}
								[/then]
							)}
							{IF_VAR current.start_equip.primary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.primary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.secondary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.secondary sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.tertiary greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.tertiary sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items ranged
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items ranged")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit weapons.ranged (
				[calculate_weapon_display]
					unit_variable=current.unit
					weapon_variable=current.unit.variables.inventory.weapons.ranged[$i]
				[/calculate_weapon_display]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						{WBD_DISPLAY_WEAPON current.unit.variables.inventory.weapons.ranged[$i] $display_damage| $display_number|}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.weapons.ranged[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.weapons.ranged[$i]}
							{IF_VAR current.unit.variables.equipment_slots.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.ranged sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged equals $i (
								[then]
									{VARIABLE current.start_equip.ranged -1}
								[/then]
							)}
							{IF_VAR current.start_equip.ranged greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.ranged sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items head
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items head")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit armor.head (
				[describe_item]
					item=current.unit.variables.inventory.armor.head[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						# {DISPLAY_HEAD_ARMOR current.unit.variables.inventory.armor.head[$i]}
						image=$value.image
						label=$value.label
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.head[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.head[$i]}
							{IF_VAR current.unit.variables.equipment_slots.head_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.head_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.head equals $i (
								[then]
									{VARIABLE current.start_equip.head -1}
								[/then]
							)}
							{IF_VAR current.start_equip.head greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.head sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items shield
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items shield")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit armor.shield (
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						{DISPLAY_SHIELD current.unit.variables.inventory.armor.shield[$i]}
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.shield[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.shield[$i]}
							{IF_VAR current.unit.variables.equipment_slots.shield greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.shield sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield equals $i (
								[then]
									{VARIABLE current.start_equip.shield -1}
								[/then]
							)}
							{IF_VAR current.start_equip.shield greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.shield sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items torso
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items torso")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit armor.torso (
				[describe_item]
					item=current.unit.variables.inventory.armor.torso[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						# {DISPLAY_TORSO_ARMOR current.unit.variables.inventory.armor.torso[$i]}
						image=$value.image
						label=$value.label
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.torso[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.torso[$i]}
							{IF_VAR current.unit.variables.equipment_slots.torso_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.torso_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso equals $i (
								[then]
									{VARIABLE current.start_equip.torso -1}
								[/then]
							)}
							{IF_VAR current.start_equip.torso greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.torso sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items legs
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items legs")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit armor.legs (
				[describe_item]
					item=current.unit.variables.inventory.armor.legs[$i]
					dest=value
				[/describe_item]
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						{DISPLAY_LEGS_ARMOR current.unit.variables.inventory.armor.legs[$i]}
						image=$value.image
						label=$value.label
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.armor.legs[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.armor.legs[$i]}
							{IF_VAR current.unit.variables.equipment_slots.leg_armor greater_than $i (
								[then]
									{VARIABLE_OP current.unit.variables.equipment_slots.leg_armor sub 1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs equals $i (
								[then]
									{VARIABLE current.start_equip.legs -1}
								[/then]
							)}
							{IF_VAR current.start_equip.legs greater_than $i (
								[then]
									{VARIABLE_OP current.start_equip.legs sub 1}
								[/then]
							)}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]
[event]
	name=wbd drop items usables
	first_time_only=no

	{WBD_INVENTORY_CANCEL_STACK_PUSH (_ "drop items usables")}
	{VARIABLE menu.level 2}
	[while]
		[variable]
			name=menu.level
			equals=2
		[/variable]
		[do]
			{CLEAR_VARIABLE drop_all}
			{CLEAR_VARIABLE menu.insert}
			{CLEAR_VARIABLE sorted_drop}
			{VARIABLE unit_path current.unit}
			{WBD_FOR_DROPPABLE current.unit usables (
				[set_variables]
					name=sorted_drop
					mode=append
					[value]
						image=$current.unit.variables.inventory.usables[$i].icon|.png
						label=_ "$current.unit.variables.inventory.usables[$i].description"
						[command]
							[drop_item]
								x=$menu.location.x
								y=$menu.location.y
								[insert_tag]
									name=item
									variable=current.unit.variables.inventory.usables[$i]
								[/insert_tag]
							[/drop_item]
							{CLEAR_VARIABLE current.unit.variables.inventory.usables[$i]}
							{VARIABLE menu.action_flag 1}
						[/command]
					[/value]
				[/set_variables]
			)}
			[set_variables]
				name=drop_all
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			[wbd_sort_array]
				name=sorted_drop
				first_key=label
				second_key=label
			[/wbd_sort_array]
			[set_variables]
				name=menu.insert
				mode=append
				to_variable=sorted_drop
			[/set_variables]
			{CLEAR_VARIABLE sorted_drop}

			[message]
				speaker=narrator
				side_for=$side_number
				[option]
					label=_ "(End)"
					image=check.png
					[command]
						[unstore_unit]
							variable=current.unit
						[/unstore_unit]
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				[insert_tag]
					name=option
					variable=menu.insert
				[/insert_tag]
				[option]
					label=_ "Drop all"
					image=icons/get-all.png
					[show_if]
						[variable]
							name=drop_all.length
							greater_than=1
						[/variable]
					[/show_if]
					[command]
						[for]
							array=drop_all
							variable=drop_j
							reverse=yes
							[do]
								[insert_tag]
									name=command
									variable=drop_all[$drop_j].command
								[/insert_tag]
							[/do]
						[/for]
					[/command]
				[/option]
				[option]
					label=_ "(Cancel)"
					image=x.png
					[command]
						{CLEAR_VARIABLE menu.action_flag}
						{VARIABLE menu.level 0}
					[/command]
				[/option]
				image=wesnoth-icon.png
			[/message]
		[/do]
	[/while]
	{IF_VAR menu.action_flag equals 1 (
		[then]
			{IF_VAR current.action.expended less_than 2 (
				[then]
					{VARIABLE current.action.expended 1}
				[/then]
				[else]
					{VARIABLE current.action.expended 3}
				[/else]
			)}
			{CLEAR_VARIABLE menu.action_flag}
		[/then]
		[else]
			{WBD_INVENTORY_CANCEL_STACK_POP}
		[/else]
	)}
	{CLEAR_VARIABLE drop_all}
	{CLEAR_VARIABLE menu.insert}
[/event]

{MODRPG_COMMAND_LOOT}
